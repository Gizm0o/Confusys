# Confusys API

A Flask-based API for managing users, roles, and machines with secure JWT authentication and role-based access control.

## Features
- User registration and login with JWT authentication
- Role-based access control (users and machines can have multiple roles)
- Admin-only role management (create, update, delete, assign/remove roles)
- Machine management (CRUD, attach roles, secure by role)
- Default admin account created at startup
- Comprehensive test suite (pytest)

## Setup

1. **Install dependencies:**
   ```sh
   pip install -r requirements.txt
   ```

2. **Configure environment:**
   - Create a `.env` file (optional) with:
     ```
     DATABASE_URL=sqlite:///confusys.db  # or your preferred DB URL
     SECRET_KEY=your-secret-key
     ```
   - Defaults: `SECRET_KEY=dev`, SQLite in-memory for tests.

3. **Run the app:**
   ```sh
   python app.py
   ```
   Or with Docker Compose:
   ```sh
   docker-compose up --build
   ```

4. **Default admin account:**
   - Username: `admin`
   - Password: `admin`
   - Email: `admin@example.com`

## API Endpoints

### Authentication
- Register: `POST /user/register` `{username, email, password}`
- Login: `POST /user/login` `{username, password}`

#### Example: Register a user
```sh
curl -X POST http://localhost:5000/user/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "john_doe",
    "email": "john@example.com",
    "password": "secure_password"
  }'
```

**Response:**
```json
{
  "message": "User registered successfully",
  "user_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

#### Example: Login
```sh
curl -X POST http://localhost:5000/user/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "john_doe",
    "password": "secure_password"
  }'
```

**Response:**
```json
{
  "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "user_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

### Roles (Admin Only)
- Create: `POST /roles` `{name, description}`
- List: `GET /roles`
- Delete: `DELETE /roles/<role_id>`
- Assign to user: `POST /roles/<role_id>/assign_user/<user_id>`
- Remove from user: `POST /roles/<role_id>/remove_user/<user_id>`
- Assign to machine: `POST /roles/<role_id>/assign_machine/<machine_id>`
- Remove from machine: `POST /roles/<role_id>/remove_machine/<machine_id>`

#### Example: Create a role
```sh
curl -X POST http://localhost:5000/roles \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "operator",
    "description": "System operator role"
  }'
```

**Response:**
```json
{
  "id": 2,
  "name": "operator",
  "description": "System operator role"
}
```

### Machines
- Create: `POST /machines` `{name, description, roles: [role_name, ...], technologies: [tech1, tech2, ...]}`
- List: `GET /machines`
- Get: `GET /machines/<machine_id>`
- Update: `PUT /machines/<machine_id>` `{name, description, roles}`
- Delete: `DELETE /machines/<machine_id>`
- **Upload file to machine:** `POST /machines/<machine_id>/files` (multipart/form-data, field: `file`)
- **List files for machine:** `GET /machines/<machine_id>/files`
- **Delete file from machine:** `DELETE /machines/<machine_id>/files/<file_id>`
- **Download audit script:** `GET /machines/<machine_id>/script`
- **List available technologies:** `GET /machines/technologies`

#### Example: Register a machine with custom technologies
```sh
curl -X POST http://localhost:5000/machines \
  -H "Authorization: Bearer <user_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "webserver01",
    "description": "Main web server",
    "roles": ["operator"],
    "technologies": ["os_kernel", "docker", "network", "users_auth"]
  }'
```

**Response:**
```json
{
  "machine_id": "550e8400-e29b-41d4-a716-446655440001",
  "token": "machine_registration_token_here",
  "script": "#!/bin/sh\n# Custom Linux Audit Script\n# Generated by Confusys\n\nTARGET_DIR=/tmp\nHOSTNAME=`hostname`\nAUDIT_NAME=\"AUDIT-$HOSTNAME-$(date +'%Y%m%d-%H%M%S')\"\nAUDIT_DIR=\"$TARGET_DIR/$AUDIT_NAME\"\nOUTFILE=\"$AUDIT_DIR.tar.gz\"\n\numask 077\nmkdir -p \"$AUDIT_DIR\"\ncd \"$AUDIT_DIR\"\n\n# OS and Kernel Info\nuname -a > uname.out 2>/dev/null\ncat /etc/*release* >> uname.out 2>/dev/null\nlsmod >lsmod.out 2>/dev/null\n/proc/config* > kernel-config.out 2>/dev/null\n\n# Docker Info\ndocker ps >docker.out 2>/dev/null\n\n# Network Info\nifconfig -a > ifconfig.out 2>/dev/null\nip a > ip.out 2>/dev/null\nnetstat -an > netstat-an.out 2>/dev/null\nss -an > ss-an.out 2>/dev/null\nnetstat -rn > netstat-rn.out 2>/dev/null\nip route show > ip-route.out 2>/dev/null\nnetstat -anp > netstat-anp.out 2>/dev/null\nss -anp > ss-anp.out 2>/dev/null\nss -lnp4 > ss.out\nss -lnp6 >> ss.out\n\n# Users and Authentication\ncat /etc/passwd > passwd.out 2>/dev/null\ncat /etc/shadow > shadow.out 2>/dev/null\ncat /etc/group > group.out 2>/dev/null\ncat /etc/sudoers > sudoers.out 2>/dev/null\ncat /etc/login* > login.out 2>/dev/null\ncat /etc/pam* > pam.out 2>/dev/null\n\ncd \"$TARGET_DIR\"\ntar czf \"$OUTFILE\" \"$AUDIT_NAME\"\necho \"$OUTFILE\" is finished, you may delete \"$AUDIT_DIR\" now.\nexit 0\n"
}
```

#### Example: List available technologies
```sh
curl -X GET http://localhost:5000/machines/technologies
```

**Response:**
```json
[
  {
    "key": "os_kernel",
    "description": "Operating system and kernel information"
  },
  {
    "key": "docker",
    "description": "Docker container information"
  },
  {
    "key": "network",
    "description": "Network interfaces and connections"
  },
  {
    "key": "users_auth",
    "description": "User accounts and authentication configuration"
  },
  {
    "key": "selinux",
    "description": "SELinux security status"
  }
]
```

#### Example: Download audit script
```sh
curl -X GET http://localhost:5000/machines/<machine_id>/script \
  -H "Authorization: Bearer <user_token>"
```

**Response:** Returns the bash script as a downloadable file.

#### Example: Upload a file to a machine
```sh
curl -X POST http://localhost:5000/machines/<machine_id>/files \
  -H "Authorization: Bearer <user_token>" \
  -F "file=@/path/to/yourfile.txt"
```

**Response:**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440002",
  "filename": "yourfile.txt"
}
```

#### Example: List files for a machine
```sh
curl -X GET http://localhost:5000/machines/<machine_id>/files \
  -H "Authorization: Bearer <user_token>"
```

**Response:**
```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440002",
    "filename": "yourfile.txt"
  }
]
```

#### Example: Delete a file from a machine
```sh
curl -X DELETE http://localhost:5000/machines/<machine_id>/files/<file_id> \
  -H "Authorization: Bearer <user_token>"
```

**Response:**
```json
{
  "message": "File deleted successfully"
}
```

### Rules
- Upload: `POST /rules` (multipart/form-data, field: `file`, optional `description`, `roles`)
- List: `GET /rules`
- Get: `GET /rules/<rule_id>` (add `?download=1` to download the file)
- Update: `PUT /rules/<rule_id>` (multipart/form-data, owner or admin only)
- Delete: `DELETE /rules/<rule_id>` (owner or admin only)

Rules are files uploaded by users, associated with roles for access control. Only users with a matching role (or admin, or the owner) can manage or view a rule.

#### Example: Upload a rule file
```sh
curl -X POST http://localhost:5000/rules \
  -H "Authorization: Bearer <user_token>" \
  -F "file=@/path/to/yourrule.txt" \
  -F "description=My parsing rule" \
  -F "roles=operator" -F "roles=analyst"
```

**Response:**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440003",
  "filename": "yourrule.txt",
  "description": "My parsing rule"
}
```

#### Example: List rules
```sh
curl -X GET http://localhost:5000/rules \
  -H "Authorization: Bearer <user_token>"
```

**Response:**
```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440003",
    "filename": "yourrule.txt",
    "description": "My parsing rule",
    "roles": ["operator", "analyst"]
  }
]
```

#### Example: Get rule metadata
```sh
curl -X GET http://localhost:5000/rules/<rule_id> \
  -H "Authorization: Bearer <user_token>"
```

**Response:**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440003",
  "filename": "yourrule.txt",
  "description": "My parsing rule",
  "roles": ["operator", "analyst"]
}
```

#### Example: Download a rule file
```sh
curl -X GET "http://localhost:5000/rules/<rule_id>?download=1" \
  -H "Authorization: Bearer <user_token>"
```

**Response:** Returns the rule file as a downloadable file.

## Example Usage

### Register and Login
```sh
curl -X POST http://localhost:5000/user/register \
  -H "Content-Type: application/json" \
  -d '{"username": "user1", "email": "user1@example.com", "password": "pass"}'

curl -X POST http://localhost:5000/user/login \
  -H "Content-Type: application/json" \
  -d '{"username": "user1", "password": "pass"}'
# Response includes {"token": "..."}
```

### Create a Role (admin only)
```sh
curl -X POST http://localhost:5000/roles \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{"name": "operator", "description": "Operator role"}'
```

### Create a Machine (with role)
```sh
curl -X POST http://localhost:5000/machines \
  -H "Authorization: Bearer <user_token>" \
  -H "Content-Type: application/json" \
  -d '{"name": "Machine1", "description": "Test machine", "roles": ["operator"]}'
```

## Testing
Run all tests with:
```sh
pytest tests/
```

## Notes
- Only admin users can manage roles and assign them to users/machines.
- Users can only access machines if they share at least one role with the machine, unless they are admin.
- All endpoints require JWT authentication except registration and login.
- **Type hints and linter compatibility:**
  - Type hints and linter silencing comments (e.g., `# type: ignore`) have been added to SQLAlchemy relationship fields in the models (such as `roles` on `User` and `Machine`).
  - All usages of the legacy `.query.get(...)` pattern in the API routes (including `/machines`) have been updated to use `db.session.get(...)` for SQLAlchemy 2.x compatibility.
  - This eliminates legacy warnings and ensures the codebase is forward-compatible with modern SQLAlchemy.
  - These changes also help static analysis tools and linters understand the intended types, since SQLAlchemy's dynamic attributes can confuse them.
  - If you see linter warnings about `RelationshipProperty` or similar, these can be safely ignored as they are false positives from static analysis tools not fully understanding SQLAlchemy's runtime behavior.
- **Modular Audit Script:**
  - The audit script is now fully modular: each technology or subsystem is a selectable block.
  - When registering a machine, users can select which technologies to include in the script via the API.
  - The generated script is stored per machine and can be downloaded via the API.
  - All available technologies and their descriptions can be listed via `GET /machines/technologies`.